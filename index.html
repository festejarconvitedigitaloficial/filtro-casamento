<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtro Vﾃｭdeo Casamento</title>
    <style>
        body { 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: #111; 
            font-family: sans-serif; 
            padding-top: 20px;
        }
        
        /* Container da cﾃ｢mera */
        #canvas-container {
            position: relative;
            width: 90%; 
            max-width: 400px;
            aspect-ratio: 9/16;
            background: #000;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        canvas { width: 100%; height: 100%; object-fit: cover; }
        
        /* Indicador de Gravaﾃｧﾃ｣o */
        #record-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: red;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: none; /* Escondido por padrﾃ｣o */
            font-weight: bold;
            z-index: 10;
        }

        /* ﾃ〉ea dos botﾃｵes de troca de filtro */
        .controls { 
            margin-top: 25px; 
            display: flex; 
            gap: 15px; 
            justify-content: center;
        }

        button {
            padding: 12px 25px;
            font-size: 14px;
            border: none;
            border-radius: 50px; 
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            white-space: nowrap; /* Impede quebras de linha */
        }

        /* Estilo Botﾃ｣o 1: Floral (Lavanda) */
        .btn-lil { 
            background-color: #E6E6FA; 
            color: #554455; 
            border: 1px solid #E6E6FA;
        }
        
        /* Estilo Botﾃ｣o 2: Minimalista (Preto/Branco) */
        .btn-min { 
            background-color: transparent; 
            color: white; 
            border: 1px solid rgba(255,255,255,0.7); 
        }

        /* Botﾃ｣o Gravar/Parar (Dourado) */
        .btn-record { 
            background: linear-gradient(90deg, #bf953f, #fcf6ba, #bf953f); /* Efeito ouro */
            color: #4a3b10; 
            margin-top: 25px; 
            width: 80%;
            max-width: 300px;
            padding: 15px;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(191, 149, 63, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Estilo do botﾃ｣o quando estﾃ｡ gravando */
        .btn-recording {
            background: red !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.5) !important;
        }
        
        button:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="canvas-container">
        <div id="record-indicator">閥 GRAVANDO</div>
        <canvas id="videoCanvas"></canvas>
    </div>

    <div class="controls">
        <button class="btn-lil" onclick="setFrame(1)">減 Floral</button>
        <button class="btn-min" onclick="setFrame(2)">笨ｨ Minimalista</button>
    </div>

    <button class="btn-record" id="recordButton" onclick="toggleRecording()">
        <span id="recordText">汐 GRAVAR Vﾃ好EO</span>
    </button>

    <script>
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');
        const recordButton = document.getElementById('recordButton');
        const recordText = document.getElementById('recordText');
        const recordIndicator = document.getElementById('record-indicator');
        
        // Configuraﾃｧﾃｵes
        canvas.width = 1080;
        canvas.height = 1920;
        const FPS = 30; // Frames por segundo para a gravaﾃｧﾃ｣o
        
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        
        let currentFrame = new Image();
        const frameSrc1 = 'moldura_lilas.png';       // Moldura 1
        const frameSrc2 = 'moldura_minimalista.png'; // Moldura 2
        
        currentFrame.src = frameSrc1;

        // Elemento de vﾃｭdeo oculto para capturar a cﾃ｢mera
        const videoElement = document.createElement('video');
        videoElement.setAttribute('playsinline', ''); 
        videoElement.play();
        
        // ---------------------------------------------------------
        // 1. Lﾃｳgica de Desenho e Renderizaﾃｧﾃ｣o (Vﾃｭdeo + Moldura)
        // ---------------------------------------------------------
        function draw() {
            if (!stream) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Lﾃｳgica de "Cover" para preencher a tela com o vﾃｭdeo da cﾃ｢mera (Selfie)
            const videoRatio = videoElement.videoWidth / videoElement.videoHeight;
            const canvasRatio = canvas.width / canvas.height;
            let drawWidth, drawHeight, startX, startY;

            if (videoRatio > canvasRatio) {
                drawHeight = canvas.height;
                drawWidth = drawHeight * videoRatio;
                startX = (canvas.width - drawWidth) / 2;
                startY = 0;
            } else {
                drawWidth = canvas.width;
                drawHeight = drawWidth / videoRatio;
                startX = 0;
                startY = (canvas.height - drawHeight) / 2;
            }

            // Espelhamento horizontal (Selfie)
            ctx.save();
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(videoElement, startX, startY, drawWidth, drawHeight);
            ctx.restore();

            // Desenha a moldura por cima
            if (currentFrame.complete) {
                ctx.drawImage(currentFrame, 0, 0, canvas.width, canvas.height);
            }
            
            requestAnimationFrame(draw);
        }

        // ---------------------------------------------------------
        // 2. Controle de Cﾃ｢mera e Gravaﾃｧﾃ｣o
        // ---------------------------------------------------------
        async function startCamera() {
            try {
                // Pede permissﾃ｣o para Vﾃｭdeo E ﾃ「dio
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1080 }, height: { ideal: 1920 } },
                    audio: true
                });
                
                videoElement.srcObject = stream;
                draw(); // Comeﾃｧa a renderizaﾃｧﾃ｣o
            } catch (err) {
                alert("Erro ao acessar Cﾃ｢mera ou Microfone: " + err + ". Certifique-se de que as permissﾃｵes foram concedidas.");
            }
        }
        
        function setFrame(option) {
            if (option === 1) currentFrame.src = frameSrc1;
            if (option === 2) currentFrame.src = frameSrc2;
        }

        function toggleRecording() {
            if (!stream) {
                alert("Cﾃ｢mera nﾃ｣o iniciada.");
                return;
            }
            
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            // Cria um stream a partir do Canvas (vﾃｭdeo) e combina com o ﾃ｡udio
            const canvasStream = canvas.captureStream(FPS);
            const audioTracks = stream.getAudioTracks();
            if (audioTracks.length > 0) {
                canvasStream.addTrack(audioTracks[0]);
            }

            mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm; codecs=vp8,opus' });
            
            recordedChunks = [];
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = downloadVideo;
            
            mediaRecorder.start();
            isRecording = true;
            recordButton.classList.add('btn-recording');
            recordText.textContent = '尅 PARAR GRAVAﾃﾃグ';
            recordIndicator.style.display = 'block';
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            recordButton.classList.remove('btn-recording');
            recordText.textContent = 'PROCESSANDO...';
            recordIndicator.style.display = 'none';
        }

        function downloadVideo() {
            recordText.textContent = '汐 GRAVAR Vﾃ好EO';
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'video_casamento_' + Date.now() + '.webm';
            document.body.appendChild(a);
            a.click();
            
            window.URL.revokeObjectURL(url);
        }

        // Inicia a cﾃ｢mera ao carregar a pﾃ｡gina
        startCamera();
    </script>
</body>
</html>
