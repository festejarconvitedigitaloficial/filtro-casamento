<!doctype html>
<html lang="pt-br" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Filtro Vídeo Casamento</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        html, body { 
            margin: 0; 
            padding: 0; 
            height: 100%;
            overflow: hidden;
        }
        
        body { 
            background-color: #111; 
            width: 100%;
            position: fixed; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* VÍDEO & MOLDURA */
        #camera { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: 1; 
        }
        
        #moldura { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: fill; 
            z-index: 2; 
            pointer-events: none; 
        }

        /* CONTROLES GERAIS */
        .controls-area {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            align-items: center;
            padding-bottom: 25px; 
            z-index: 999;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
        }

        /* LINHA PRINCIPAL */
        .main-action-line {
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 10px;
        }
        
        .btn { 
            cursor: pointer; 
            transition: transform 0.1s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
        }
        
        .btn:active { 
            transform: scale(0.9); 
        }

        /* Botões de Filtro */
        .btn-filter {
            padding: 6px 10px;
            border-radius: 50px; 
            border: none;
            font-size: 11px; 
            font-weight: 600; 
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-lil { 
            background-color: #E6E6FA; 
            color: #554455; 
        }
        
        .btn-min { 
            background-color: #222; 
            color: white; 
            border: 1px solid rgba(255,255,255,0.7); 
        }

        /* BOTÃO TIRAR FOTO */
        .btn-shot {
            width: 60px; 
            height: 60px;
            background: #fff;
            border: 3px solid #e0e0e0; 
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23333'%3E%3Cpath d='M20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 14H4V7h4.05l1.83-2h4.24l1.83 2H20v12zM12 9c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z'/%3E%3C/svg%3E");
            background-size: 50%; 
            background-position: center; 
            background-repeat: no-repeat;
        }

        /* BOTÃO VÍDEO */
        .btn-video {
            width: 50px; 
            height: 50px;
            background: #c0392b; 
            border: 3px solid white; 
            border-radius: 50%;
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        
        .icon-cam-img {
            width: 24px; 
            height: 24px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; 
            background-position: center;
        }

        /* BOTÃO VIRAR CÂMERA */
        .btn-flip {
            width: 50px; 
            height: 50px;
            background: rgba(255,255,255,0.2); 
            border: 2px solid white; 
            border-radius: 50%;
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        
        .icon-flip-img {
            width: 24px; 
            height: 24px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7v-2.09c-2.83-.48-5-2.94-5-5.91s2.17-5.43 5-5.91V5h10v10h-2.09c-.48 2.83-2.94 5-5.91 5h-2v2h2c3.87 0 7-3.13 7-7V7c0-1.1-.9-2-2-2zm-6 8l-4-4 4-4zm-1 0l4-4-4-4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; 
            background-position: center;
        }

        /* Flash de captura */
        .flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        .flash.active {
            opacity: 0.8;
        }

        /* Mensagens */
        .message {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 9998;
            display: none;
        }

        .message.show {
            display: block;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <video id="camera" autoplay playsinline></video><img id="moldura" alt="Moldura decorativa">
  <div class="flash" id="flash"></div>
  <div class="message" id="message"></div>
  <div class="controls-area">
   <div class="main-action-line"><button class="btn btn-filter btn-lil" id="btnFilter1">Filtro 1</button> <button class="btn btn-shot" id="btnShot"></button> <button class="btn btn-filter btn-min" id="btnFilter2">Filtro 2</button> <button class="btn btn-flip" id="btnFlip">
     <div class="icon-flip-img"></div></button> <button class="btn btn-video" id="btnVideo">
     <div class="icon-cam-img"></div></button>
   </div>
  </div>
  <script>
        const defaultConfig = {
            filter1_name: "Filtro 1",
            filter2_name: "Filtro 2"
        };

        let currentStream = null;
        let currentFacingMode = 'user';
        let currentFilter = 1;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];

        const molduras = {
            1: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 600"%3E%3Crect fill="%23E6E6FA" opacity="0.3" width="400" height="600"/%3E%3Cpath d="M50 50 L350 50 L350 550 L50 550 Z" fill="none" stroke="%23fff" stroke-width="8"/%3E%3C/svg%3E',
            2: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 600"%3E%3Crect fill="%23000" opacity="0.2" width="400" height="600"/%3E%3Ccircle cx="200" cy="300" r="150" fill="none" stroke="%23fff" stroke-width="6"/%3E%3C/svg%3E'
        };

        async function initCamera() {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: { 
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: true
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('camera').srcObject = currentStream;
            } catch (err) {
                showMessage('Erro ao acessar câmera: ' + err.message);
            }
        }

        function applyFilter(filterNum) {
            currentFilter = filterNum;
            document.getElementById('moldura').src = molduras[filterNum];
        }

        function showMessage(text) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 2000);
        }

        function capturePhoto() {
            const video = document.getElementById('camera');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const flash = document.getElementById('flash');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 100);

            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `foto-${Date.now()}.jpg`;
                a.click();
                showMessage('Foto capturada!');
            }, 'image/jpeg', 0.95);
        }

        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            recordedChunks = [];
            const options = { mimeType: 'video/webm;codecs=vp9' };
            
            try {
                mediaRecorder = new MediaRecorder(currentStream, options);
            } catch (e) {
                mediaRecorder = new MediaRecorder(currentStream);
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `video-${Date.now()}.webm`;
                a.click();
                showMessage('Vídeo salvo!');
            };

            mediaRecorder.start();
            isRecording = true;
            document.getElementById('btnVideo').style.background = '#e74c3c';
            showMessage('Gravando...');
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('btnVideo').style.background = '#c0392b';
        }

        function flipCamera() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            initCamera();
        }

        async function onConfigChange(config) {
            document.getElementById('btnFilter1').textContent = config.filter1_name || defaultConfig.filter1_name;
            document.getElementById('btnFilter2').textContent = config.filter2_name || defaultConfig.filter2_name;
        }

        // Event Listeners
        document.getElementById('btnFilter1').addEventListener('click', () => applyFilter(1));
        document.getElementById('btnFilter2').addEventListener('click', () => applyFilter(2));
        document.getElementById('btnShot').addEventListener('click', capturePhoto);
        document.getElementById('btnVideo').addEventListener('click', toggleRecording);
        document.getElementById('btnFlip').addEventListener('click', flipCamera);

        // Inicialização
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities: () => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["filter1_name", config.filter1_name || defaultConfig.filter1_name],
                    ["filter2_name", config.filter2_name || defaultConfig.filter2_name]
                ])
            });
        }

        initCamera();
        applyFilter(1);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ad15402766ef200',t:'MTc2NTU4NTU2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
